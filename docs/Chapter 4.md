# Chapter 4. General program design of filter

## 处理随机信号的两种途径

对于某随机过程，预测其随时间演化过程是常见的任务。通常会使用先验知识与模型然后基于概率推演，这也是一般随机过程分析常用的思路，如贝叶斯分析[^1]。但当随机过程中关注的变量间有较强的独立性与周期性时，也可以通过傅里叶变换在频率域中直接操作其频谱，根据需要进行具体的频率频率成型操作[^2]。

对于这类时间演化系统的估计，根据使用数据因果性，可具体分成三类任务：

- 滤波（filter）: 基于系统前n时刻的历史数据（含当前）估计下一时刻数据。

- 平滑（smooth）: 收集系统一段时间n内数据，根据所有数据，得到每个时刻的数据。

- 预测（predict）: 基于系统前n时刻的历史数据（含当前）估计n+t刻数。

三类任务本质上同种同源，只是根据时间因果性进行区分。因此很多算法：如Savizkg-Golay平滑算法被称作Savizkg-Golay滤波器；均值滤波器的与滑动平均有同样的数学表达。除有特殊情况，之后视作等同。

本章讨论频率成型的统计线性滤波器通用数学模型与程序设计方法。

## 统计线性滤波器

### 统计线性滤波器的数学模型

随机过程的频域分析法是提取信号中周期成分然后再进行积分变换在频率域上分析的一种手段。其理论基础是随机过程本身能被模拟成各种特定频率谐波叠加的系统。在这之上操作这些谐波成分的技术称为统计线性估计/滤波/平滑。

在以上假设下，将随机过程$x_t$输入以下差分系统：
$$
y_{n}=\sum_{k=0}^{M} c_{k} x_{n-k}+\sum_{j=0}^{N-1} d_{j} y_{n-j-1} \tag{1}
$$
其中$y_n$是在系统对应离散输入$x_t$的输出。通过给输入与输出设定不同的系数，就能组合出特定性质的$y_t$。当等式右边项$y$相关系数都是零时，系统只与过去时刻输入有关，具有有限项、因果性、绝对稳定性，此时称为有限递归滤波器（FIR）；当右边项$y$相关系数不为零，系统输出与过去时刻输出有关，具有条件稳定性、因果性。相比FIR系统增加了反馈环节，等同于加入了无穷多项输入，称作无穷递归滤波器（IIR）[^1]。所有的线性滤波器都是这两类滤波器的特例。

该差分系统的频率域响应：
$$
H(f)=\frac{\sum_{k=0}^{M} c_{k} e^{-2 \pi i kf }}{1-\sum_{j=0}^{N-1} d_{j} e^{-2 \pi i(j+1)f }} \tag{2}
$$
其中$f$是使用采用频率进行归一化后的频率。改变系数能相应改变频率响应函数形状，因此通过这种方式设计的滤波器称作频率成形滤波器。

特别注意在scipy.signal等软件包中，会限制$-0.5\le f\le0.5$[^3]。因为式2通过Laplace变换连续时间域得到系统传递函数，但实际上采样是离散过程，需要使用z变换到离散频率域。当离散系统采样频率$f_s\le 2f$时，Laplace变换与z变换转换中存在混叠效应。因此这些软件包中会限制一半的频率使用，如$f_s=8000Hz$，那么滤波器频率设定范围只有$4000Hz$。

#### 统计线性滤波器的程序设计

线性统计滤波器的程序设计是围绕式1进行。式1是两项卷积之和，每项卷积有如下加乘累计结构：

![image-20230524235020703](img/image-20230524235020703.png)

这种置换卷积对应于固定位置索引与先进先出（FIFO）的队列元素的乘积和。将滤波器系数置入固定数组，然后将队列元素依次加成就得到滤波结果。

另外，为保持滤波器设计系数与MATLAB和SciPy等软件包一致，式1中有理传递函数采用如下形式：
$$
Y(z)=
\frac{b(0)+b(1)z^{−1}+...+b(M)z^{−M}}
{1+a(0)z^{−1}+...+a(N-1)z^{−N}}X(z)
$$

### FIR（Finite Impulse Response）型滤波器设计

#### 理想有限脉冲响应滤波器

FIR型滤波器系统简单表达为：
$$
y_{n}=\sum_{k=0}^{M} c_{k} x_{n-k} \tag{3}
$$

对应频率响应为：
$$
H(f)=\sum_{k=-\infin}^{\infin} h_{k} e^{-j2 \pi  kf }
$$
这是FFT-IFFT变换对。通过改变对应谐波$\Omega=2\pi f$响应系数$h_k$得到时域上不同信号形状：
$$
H(\Omega)=\sum_{k=-\infty}^{\infty} h[n] \cdot e^{-j k \Omega}\\
h[n]=\frac{1}{2 \pi} \int_{-\pi}^{\pi} H(\Omega) \cdot e^{j n \Omega} d \Omega
\tag{4}
$$
故设计FIR滤波器可以直接将频率响应进行反积分变换得到系数$h[n]$。

以设计截止频率为$\Omega_c$的理想低通滤波器为例，其频率响应为：

![image-20230522223735541](C:\Users\xtc\Desktop\matrix\docs\img\image-20230522223735541.png)

即：
$$
H(\Omega)=\begin{cases} 1\quad(-\Omega_c\le\Omega\le\Omega_c)\\ 0\quad(else) \end{cases}
\tag{5}
$$
作IFFT：
$$
h[n]=\frac{1}{2\pi}\int_{-\Omega_c}^{\Omega_c}{1\cdot e^{jn\Omega}d\Omega}=\frac{1}{2\pi}[\frac{e^{jn\Omega}}{jn}]_{-\Omega_c}^{\Omega_c}=\frac{\Omega_{c}}{\pi} \cdot \frac{\sin \left(n \Omega_{c}\right)}{\left(n \Omega_{c}\right)}=2 f_{c} \cdot \frac{\sin \left(n \Omega_{c}\right)}{\left(n \Omega_{c}\right)}
\tag{6}
$$
将式6回代入式3，得理想低通滤波器时域表达式。对该无穷级数求部分和做近似。式6是偶函数，选取中心取左右$M$点，共$N=2M+1$阶作为级数部分和。考虑因果性，将负周期前移至正半周期：
$$
H(z)=\sum_{n=-M}^{M} h[n] \cdot z^{-(n+M)}
\tag{7}
$$
以上平移与对称性表示：

一、滤波器某时刻值与该点前和该点后数据相关，即N时刻值是由N-M和N+M这些过去与未来的数据推断，这正是1.1节中所描述的平滑任务。

二、考虑到滤波任务的因果性，我们将信号整体平移M周期，即在频率域中乘以$z^{-M}$，获得$[0,2M]$时刻数据才推断M时刻数据。这带来了相位的扭曲：对于信号$y=x(t-t_0)$，相当于信号$y=x(t)$通过$H(jw)=e^{-jwt}$环节，它使系统的所有谐波成分整体相位偏移对应$t_0$周期。这种对每个谐波成分的相位扭曲称作群延迟，是滤波器相位特性的来源。

式6给出理想低通滤波器环节的反变换。相应的，理想高通、带通、带阻对应时域表达式：

| 类型 | $h[n],n\ne0$                                                 | $h[n],n=0$  |
| ---- | ------------------------------------------------------------ | ----------- |
| 低通 | $2f_c\frac{sin(n\Omega_c)}{n\Omega_c}$                       | $2f_c$      |
| 高通 | $-2f_c\frac{sin(n\Omega_c)}{n\Omega_c}$                      | $1-2f_c$    |
| 带通 | $2f_2\frac{sin(n\Omega_2)}{n\Omega_2}-2f_1\frac{sin(n\Omega_1)}{n\Omega_1}$ | $2f_2-2f_1$ |
| 带阻 | $2f_2\frac{sin(n\Omega_2)}{n\Omega_2}+2f_1\frac{sin(n\Omega_1)}{n\Omega_1}$ | $2f_2+2f_1$ |

#### 窗函数法

对式7进行有限截断导出的滤波器频域特性和理想滤波器存在区别，主要是频响有相当明显波纹：

![image-20230524215315175](img/image-20230524215315175.png)

为了去除波纹，需要对频谱使用一些函数进行进行二次加工，这些函数称作窗函数。这些窗函数能较好改变通带与阻带特性，与理想滤波器一起构成了实际使用的FIR滤波器。以三角窗（又称bartlett窗）为例，其时域上是一个三角形，而频域上则对主瓣以外成分有强烈衰减：

![image-20230524220454952](img/image-20230524220454952.png)

常用窗函数的时域表达式如下：

| 类型        | $w(n)$                                                       |
| ----------- | ------------------------------------------------------------ |
| Rectangular | 1                                                            |
| Hanning     | $0.5-0.5\cos(\frac{2\pi n}{N-1})$                            |
| Hamming     | $0.54-0.46\cos(\frac{2\pi n}{N-1})$                          |
| Blackman    | $0.42-0.5 \cos \left(\frac{2 \pi n}{N-1}\right)+0.08 \cos \left(\frac{2 \pi n}{N-1}\right)$ |

将窗函数叠加到理想滤波器系数，就得到最终滤波器系数$h[n]*w[n]$。

#### 频幅响应与相位偏移

本节给出FIR的频幅响应与相位偏移。根据式4，其传递函数为：
$$
H(j \omega)=\sum_{n=-M}^{M} h[n] \cdot e^{-j \omega T(n+M)}=e^{-j \omega T M} \sum_{n=-M}^{M} h[n] \cdot e^{-j \omega T_{n}}
\tag{7}
$$
其中$T$是采样周期。假设系数是对称分布的，有：
$$
\begin{aligned}
H(j \omega) & =e^{-j \omega T M}\left\{h(0)+\sum_{n=1}^{M} h[n] \cdot\left(e^{j \omega T n}+e^{-j \omega T n}\right)\right\} \\
& =e^{-j \omega T M}\left\{h(0)+\sum_{n=1}^{M} h[n] \cdot 2 \cos (\omega T n)\right\}
\end{aligned}
\tag{8}
$$
式8表明，该系统对对频率$w$谐波成分会产生$-wTM$线性相位偏移，此斜率即群延迟。FIR滤波器有着线性相位偏移，即对任何频率谐波成分，有相同群延迟。

#### FIR型滤波器程序设计

### IIR（Infinite Impulse Response）型滤波器设计

### 用户文档



## 贝叶斯滤波器

参考文献

[^1]: 时间序列分析，汉密尔顿
[^2]: 信号与系统，奥本海姆
[^3]: scipy.signal